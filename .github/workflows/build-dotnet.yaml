name: Build .NET
on:
  workflow_call:
    inputs:
      SDK_VERSION:
        type: string
        required: true
        description: The version of the .NET SDK to use when building.
      SOLUTION_DIR:
        type: string
        required: true
        description: The directory that contains the solution file to build.
      VERSION:
        type: string
        required: true
      IS_DEPLOYABLE:
        type: boolean
        required: true
      CONTAINS_LIBRARIES:
        type: boolean
        required: false
        default: false
env:
  BUILD_CONFIG: Release
jobs:
  dotnet-build:
    name: Run build and test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.SOLUTION_DIR }}
    steps:
      - uses: actions/checkout@v2
      - name: Set common environment variables
        run: |
          echo "REPO_URL=\"${{ env.GITHUB_SERVER }}${{ env.GITHUB_REPOSITORY }}\"" >> $GITHUB_ENV
      - name: Set pre-release version
        if: ${{ inputs.IS_DEPLOYABLE }}
        run: echo "VERSION_NUMBER=${{ inputs.VERSION }}.${{ github.run_id }}" >> $GITHUB_ENV
      - name: Set version
        if: ${{ !inputs.IS_DEPLOYABLE }}
        run: echo "VERSION_NUMBER=${{ inputs.VERSION}}-rc.${{ github.run_id }}" >> $GITHUB_ENV
      - uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ inputs.SDK_VERSION }}
      - run: dotnet build --nologo -c "${{ env.BUILD_CONFIG }}" -v minimal -p:Version="${{ env.VERSION_NUMBER }}" -p:PackageProjectUrl="${{ env.REPO_URL }}"
      - run: dotnet test --nologo --no-build -c "${{ env.BUILD_CONFIG }}" -v minimal
      - if: ${{ inputs.CONTAINS_LIBRARIES }}
        run: dotnet pack --nologo --no-build -c "${{ env.BUILD_CONFIG }}" -v minimal -p:VERSION="${{ env.VERSION_NUMBER }} -o "${{ env.GITHUB_WORKSPACE }}/artifacts/packages" -p:PackageProjectUrl="${{ env.REPO_URL }}"
  dotnet-pack:
    needs: dotnet-build
    runs-on: ubuntu-latest
    steps:
      - run: echo "${{ env.VERSION_NUMBER}}"


